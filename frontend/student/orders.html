{% extends "student/dashboard.html" %}
{% set active_page = 'orders' %}

{% block dashboard_content %}
<h4 class="fw-semibold mb-3">My Orders</h4>

{% if orders %}
<table class="table table-hover align-middle">
  <thead>
    <tr>
      <th>Order ID</th>
      <th>Date</th>
      <th>Status</th>
      <th>Total Amount (₹)</th>
      <th>Details</th>
    </tr>
  </thead>
  <tbody>
    {% for order in orders %}
    {% set total = order.order_details | sum(attribute='price') %}
    <tr>
      <td>{{ order.orderID }}</td>
      <td>{{ order.orderDate.strftime('%Y-%m-%d %H:%M') }}</td>
      <td>{{ order.status }}</td>
      <td>₹{{ total }}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#details-{{ order.orderID }}">
          View
        </button>
      </td>
    </tr>
    <tr class="collapse" id="details-{{ order.orderID }}">
      <td colspan="5">
        <ul class="list-group">
          {% for od in order.order_details %}
            <li class="list-group-item d-flex justify-content-between">
              {{ od.item.title }} × {{ od.quantity }} 
              <span>₹{{ od.price }}</span>
            </li>
          {% endfor %}
          {% if order.voucher %}
          <li class="list-group-item d-flex justify-content-between">
            <strong>Voucher Applied:</strong> {{ order.voucher.discountPercent }}% off
            <span>-₹{{ order.voucher.applyVoucher(order) }}</span>
          </li>
          {% endif %}
          <li class="list-group-item d-flex justify-content-between">
            <strong>Grand Total:</strong>
            <span>₹{{ order.order_details | sum(attribute='price') - (order.voucher.applyVoucher(order) if order.voucher else 0) }}</span>
          </li>
        </ul>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% else %}
<div class="alert alert-info">You haven't placed any orders yet. Browse the <a href="{{ url_for('student.marketplace') }}">marketplace</a> to shop!</div>
{% endif %}
{% endblock %}
