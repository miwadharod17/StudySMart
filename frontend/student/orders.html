{% extends "student/dashboard.html" %}
{% set active_page = 'orders' %}

{% block dashboard_content %}
<h4 class="fw-semibold mb-3">My Orders</h4>

{% if orders %}
<table class="table table-hover align-middle">
  <thead>
    <tr>
      <th>Order ID</th>
      <th>Date</th>
      <th>Status</th>
      <th>Total Amount (₹)</th>
      <th>Details</th>
    </tr>
  </thead>
  <tbody>
    {% for order in orders %}
      {% set order_total = 0 %}
      {% for od in order.order_details %}
        {% set order_total = order_total + (od.price * od.quantity) %}
      {% endfor %}
      {% set discount = order.voucher.applyVoucher(order) if order.voucher else 0 %}
      {% set grand_total = order_total - discount %}

      <tr>
        <td>{{ order.orderID }}</td>
        <td>{{ order.orderDate.strftime('%Y-%m-%d %H:%M') }}</td>
        <td>
          <span class="badge bg-{{ 'success' if order.status=='Paid' else 'secondary' }}">{{ order.status }}</span>
        </td>
        <td>₹{{ grand_total }}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#details-{{ order.orderID }}">
            View
          </button>
        </td>
      </tr>

      <tr class="collapse" id="details-{{ order.orderID }}">
        <td colspan="5">
          <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <strong>Order {{ order.orderID }}</strong>
              <small>{{ order.orderDate.strftime('%d %b %Y, %H:%M') }}</small>
            </div>
            <ul class="list-group list-group-flush">
              {% for od in order.order_details %}
                {% set subtotal = od.price * od.quantity %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ od.item.title }}</strong> × {{ od.quantity }}<br>
                    <small class="text-muted">
                      Category: {{ od.item.category or '-' }} |
                      Seller: {{ od.item.seller.userID }} - {{ od.item.seller.name }}
                    </small>
                  </div>
                  <div>₹{{ subtotal }}</div>
                </li>
              {% endfor %}
              {% if order.voucher %}
                <li class="list-group-item d-flex justify-content-between">
                  <strong>Voucher Applied:</strong> {{ order.voucher.discountPercent }}% off
                  <span>-₹{{ discount }}</span>
                </li>
              {% endif %}
              <li class="list-group-item d-flex justify-content-between">
                <strong>Grand Total:</strong>
                <span>₹{{ grand_total }}</span>
              </li>
            </ul>
          </div>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<div class="alert alert-info">
  You haven't placed any orders yet. Browse the <a href="{{ url_for('student.marketplace') }}">marketplace</a> to shop!
</div>
{% endif %}

{% endblock %}
